{
    "jobs": {
        "main": [
            {
                "image": "node:4",
                "commands": [
                    {
                        "name": "init",
                        "command": "npm install"
                    },
                    {
                        "name": "test",
                        "command": "npm test"
                    }
                ],
                "environment": {
                    "NODE_ENV": "test",
                    "NODE_VERSION": "4"
                },
                "requires": ["~pr", "~commit", "~sd@12345:test", "stage@canary:setup"]
            },
            {
                "image": "node:5",
                "commands": [
                    {
                        "name": "init",
                        "command": "npm install"
                    },
                    {
                        "name": "test",
                        "command": "npm test"
                    }
                ],
                "environment": {
                    "NODE_ENV": "test",
                    "NODE_VERSION": "5"
                },
                "requires": ["~pr", "~commit", "~sd@12345:test", "stage@canary:setup"]
            },
            {
                "image": "node:6",
                "commands": [
                    {
                        "name": "init",
                        "command": "npm install"
                    },
                    {
                        "name": "test",
                        "command": "npm test"
                    }
                ],
                "environment": {
                    "NODE_ENV": "test",
                    "NODE_VERSION": "6"
                },
                "requires": ["~pr", "~commit", "~sd@12345:test", "stage@canary:setup"]
            }
        ],
        "publish": [
            {
                "image": "node:4",
                "commands": [
                    {
                        "name": "bump",
                        "command": "npm run bump"
                    },
                    {
                        "name": "publish",
                        "command": "npm publish --tag $NODE_TAG"
                    },
                    {
                        "name": "tag",
                        "command": "git push origin --tags"
                    }
                ],
                "environment": {
                    "NODE_ENV": "test",
                    "NODE_TAG": "latest"
                },
                "requires": ["main"]
            }
        ],
        "A": [
            {
                "image": "node:4",
                "commands": [
                    {
                        "name": "echo",
                        "command": "echo hi"
                    }
                ],
                "requires": ["stage@deploy:setup"]
            }
        ],
        "B": [
            {
                "image": "node:4",
                "commands": [
                    {
                        "name": "echo",
                        "command": "echo bye"
                    }
                ],
                "requires": ["A"]
            }
        ],
        "stage@canary:setup": [
            {
                "image": "node:4",
                "commands": [
                    {
                        "name": "announce",
                        "command": "post banner"
                    }
                ]
            }
        ],
        "stage@canary:teardown": [
            {
                "image": "node:4",
                "commands": [
                    {
                        "name": "publish",
                        "command": "publish blog"
                    }
                ]
            }
        ],
        "stage@deploy:setup": [
            {
                "image": "node:4",
                "commands": [
                    {
                        "name": "announce",
                        "command": "post banner"
                    }
                ]
            }
        ],
        "stage@deploy:teardown": [
            {
                "image": "node:4",
                "commands": [
                    {
                        "name": "publish",
                        "command": "publish blog"
                    }
                ]
            }
        ]
    },
    "workflow": [],
    "workflowGraph": {
        "nodes": [
            { "name": "~pr" },
            { "name": "~commit" },
            { "name": "stage@canary" },
            { "name": "stage@deploy" }
        ],
        "edges": [
            { "src": "~pr", "dest": "stage@canary" },
            { "src": "~commit", "dest": "stage@canary" }
        ]
    },
    "annotations": {
        "beta.screwdriver.cd/executor" : "screwdriver-executor-vm"
    },
    "stages": {
        "canary": {
            "startFrom": "main",
            "description": "Canary deployment",
            "jobs": ["main", "publish"],
            "workflowGraph": {
                "nodes": [
                    { "name": "main" },
                    { "name": "publish" },
                    { "name": "stage@canary:setup" },
                    { "name": "stage@canary:teardown" }
                ],
                "edges": [
                    { "src": "main", "dest": "publish" }
                ]
            }
        },
        "deploy": {
            "startFrom": "A",
            "description": "Prod deployment",
            "jobs": ["A", "B"],
            "workflowGraph": {
                "nodes": [
                    { "name": "A" },
                    { "name": "B" },
                    { "name": "stage@deploy:setup" },
                    { "name": "stage@deploy:teardown" }
                ],
                "edges": [
                    { "src": "A", "dest": "B" }
                ]
            }
        }
    }
}
